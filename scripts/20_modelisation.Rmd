---
title: "Spirlin dans le bassin Adour-Garonne"
subtitle: "Modélisation"
author: "OFB"
date: "`r format(Sys.time(), 'Le %d %B %Y')`"
output:
  html_document:
    code_folding: show
    toc: true
    toc_float: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Chargement des packages et des données

```{r}
# devtools::install_github("pascalirz/aspeQual")
# devtools::install_github("NicolasQuoquillaud/AspeEEE")
library(tidyverse)
library(aspe)
library(AspeEEE)
library(flextable)
library(aspeQual)
library(stats)
```


# Impact du spirlin sur l'IPR

## Préparation du tableau de données

On part des données prétraitées par le script précédent.

```{r}
load(file = "../processed_data/spirlin_dfs.RData")
```

Identifiants des stations avec du spirlin :

```{r}
sta_avec_spi <- ope_data %>% 
  filter(eff_spi > 0) %>% 
  pull(sta_id) %>% 
  unique()
```

Sélection et enrichissement du tableau :

- Sélection des données sur les stations avec spirlin
- Codage d'une variable de présence / absence du spirlin
- Suppression des opérations sans valeur de l'IPR
- Ajout des métriques et des libellés des points / stations
- Sélection des variables d'intérêt


```{r}
mod_data <- ope_data %>% 
  filter(sta_id %in% sta_avec_spi) %>% 
  mutate(spi = ifelse(eff_spi > 0,
                      "Présence",
                      "Absence")) %>% 
  mef_ajouter_ipr() %>% 
  filter(!is.na(ipr)) %>% 
  mef_ajouter_metriques() %>% 
  mef_ajouter_libelle() %>% 
  select(sta_id,
         pop_id,
         pop_libelle,
         annee,
         spi,
         ipr,
         ner:dti) %>% 
  mutate(pop_id = as.factor(pop_id))

```

## Distribution des variables

Sans transformation :

```{r}
gg <- mod_data %>% 
  pivot_longer(cols = c(ipr:dti, annee),
               names_to = "metrique",
               values_to = "valeur") %>% 
  ggplot(aes(x = valeur)) +
    geom_histogram() +
    facet_wrap(~ metrique,
               scales = "free")

gg

```

Certaines métriques sont distribuées de manière très asymétrique (en particulier `dii`), donc on essaye une transformation log :

```{r}
gg + scale_x_log10()
```

>Les distributions sont plus proches de distributions en cloche après transformations log.

On transforme donc les métriques mais pas l'année où ça n'apporte rien.

```{r}
mod_data <- mod_data %>%
  mutate(across(ipr:dti, ~ log(.)))
```



## Modélisation

La fonction `lm_annee_spi()` du package `AspeEEE` permet de modéliser une (ou des) variable(s) en fonction de l'année et de la présence / absence du spirlin. Elle renvoie les résultats du (ou des) modèle(s)sous forme de tableau résumé. Ici le modèle employé est linéaire, de la forme :

`métrique ~ pop_id + annee + spi`

On recherche donc les effets indépendants des stations (afin de les contrôler), de l'année et de la présence du spirlin. 
 
Vecteur contenant les noms des métriques à modéliser (à partir des noms des colonnes entre ipr et dti).

```{r}
mes_metriques <- mod_data %>% 
  select(ipr:dti) %>% 
  colnames()

mes_metriques
```

Ajustement des modèles. On précise `interaction = FALSE` car du fait de la colinéarité entre `annee` et `spi`, un terme d'interaction serait délicat à interpréter.

```{r}
res <- lm_annee_spi(model_data = mod_data,
                    metriques = mes_metriques,
                    interaction = FALSE)
```

Affichage. Le tableau est mis en forme avec les fonctions du package `flextable`. L'IPR est distingué par l'arrière-plan de couleur.


```{r}
res %>% 
  flextable() %>% 
  align(j = 2:4, align = "center", part = "all") %>% 
  set_table_properties(layout = "autofit", width = 1) %>% 
  bg(i = 1, bg = "lightgreen")
```


## Interprétation

Une ligne représente une métrique. On voit, pour chacune des variables explicatives, le coefficient associé, et entre parenthèses le niveau de significativité :

- (NS) non significatif au seuil de 5%
- (*) p < 5%
- (**) p < 1%
- (***) p < 0.1%

On entend par significativité le fait d'être significativement différent de zéro.

L'intercept du modèle est sa constante. C'est la valeur que prendrait la métrique (ici en fait le log de la métrique) en l'an zéro en l'absence de spirlin.

**Exemple :**

Pour la métrique `dit`, on a un effet `année` significatif avec un coefficient de `r res %>% filter(Métrique == "dit") %>% pull(Année) %>% str_replace(" \\s*\\([^\\)]+\\)", "")`. Ce coefficient est négatif $\Rightarrow$ la métrique diminue au fil du temps, en moyenne sur l'ensemble des stations. L'effet de la présence du spirlin (`spiPrésence`) est significatif avec un coefficient de `r res %>% filter(Métrique == "dit") %>% pull(spiPrésence)`. Les valeurs du log de la métrique, quelle que soit l'année, sont donc inférieures de `r res %>% filter(Métrique == "dit") %>% pull(spiPrésence) %>% str_replace(" \\s*\\([^\\)]+\\)", "")` en présence du spirlin par rapport à son absence.






